name: CD

on:
    push:
        branches: ["main"]
    workflow_dispatch:

permissions:
    contents: read
    packages: write

concurrency:
    group: cd-${{ github.ref }}
    cancel-in-progress: true

env:
    REGISTRY: ghcr.io
    IMAGE_OWNER: ${{ github.repository_owner }}
    NAMESPACE: vsp-blockchain

jobs:
    build-and-push:
        name: Build and push Docker images
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                include:
                    - component: miner
                      context: ./p2p-blockchain
                      dockerfile: ./p2p-blockchain/Dockerfile
                    - component: rest-api
                      context: ./rest-schnittstelle
                      dockerfile: ./rest-schnittstelle/Dockerfile
                    - component: registry-crawler
                      context: ./registry-crawler
                      dockerfile: ./registry-crawler/Dockerfile
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup project
              uses: ./.github/actions/setup

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push image
              uses: docker/build-push-action@v6
              with:
                  context: ${{ matrix.context }}
                  file: ${{ matrix.dockerfile }}
                  push: true
                  tags: |
                      ${{ format('{0}/{1}/{2}-{3}:{4}', env.REGISTRY, env.IMAGE_OWNER, env.NAMESPACE, matrix.component, github.sha) }}
                      ${{ format('{0}/{1}/{2}-{3}:latest', env.REGISTRY, env.IMAGE_OWNER, env.NAMESPACE, matrix.component) }}
                  cache-from: type=gha,scope=${{ matrix.component }}
                  cache-to: type=gha,mode=max,scope=${{ matrix.component }}

    deploy:
        name: Deploy to Kubernetes
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up kubectl
              uses: azure/setup-kubectl@v4

            - name: Configure kubeconfig
              uses: ./.github/actions/fetch_current_cube_config
              with:
                  ICC_PASSWORD: ${{ secrets.ICC_PASSWORD }}

            - name: Get OpenVPN Config from Secrets
              run: |
                  echo "$OPENVPN_CONFIG" | base64 --decode > vpn.ovpn
              env:
                  OPENVPN_CONFIG: ${{ secrets.OPENVPN_CONFIG }}

            - name: Install OpenVPN
              run: |
                  sudo apt update
                  sudo apt install -y openvpn openvpn-systemd-resolved

            - name: Connect to VPN
              uses: kota65535/github-openvpn-connect-action@v3.1.0
              with:
                  echo_config: "false"
                  config_file: vpn.ovpn

            - name: Deploy to Kubernetes
              env:
                  KUBECONFIG: "~/.kube/config"
              run: |
                  export KUBECONFIG="${HOME}/.kube/config"
                  kubectl apply -f kubernetes-miner.yaml
                  kubectl apply -f kubernetes-registry.yaml
                  kubectl apply -f kubernetes-rest_api.yaml

            - name: Update images to newly published tag
              env:
                  NAMESPACE: ${{ env.NAMESPACE }}
                  MINER_TAG: ${{ format('{0}/{1}/{2}-miner:{3}', env.REGISTRY, env.IMAGE_OWNER, env.NAMESPACE, github.sha) }}
                  REST_TAG: ${{ format('{0}/{1}/{2}-rest-api:{3}', env.REGISTRY, env.IMAGE_OWNER, env.NAMESPACE, github.sha) }}
                  REGISTRY_CRAWLER_TAG: ${{ format('{0}/{1}/{2}-registry-crawler:{3}', env.REGISTRY, env.IMAGE_OWNER, env.NAMESPACE, github.sha) }}
              run: |
                  kubectl -n "$NAMESPACE" set image statefulset/miner miner="$MINER_TAG"
                  kubectl -n "$NAMESPACE" set image deployment/rest-api rest-api="$REST_TAG"
                  kubectl -n "$NAMESPACE" set image deployment/registry registry-crawler="$REGISTRY_CRAWLER_TAG"

            - name: Wait for rollout
              env:
                  NAMESPACE: ${{ env.NAMESPACE }}
              run: |
                  kubectl -n "$NAMESPACE" rollout status statefulset/miner --timeout=600s
                  kubectl -n "$NAMESPACE" rollout status deployment/rest-api --timeout=180s
                  kubectl -n "$NAMESPACE" rollout status deployment/registry --timeout=180s
