services:
    minimal_node:
        build:
            context: ./p2p-blockchain
            dockerfile: Dockerfile
        image: vsp-blockchain/miner:local
        environment:
            APP_PORT: "50050"
            P2P_PORT: "50051"
            APP_LISTEN_ADDR: "0.0.0.0"
            P2P_LISTEN_ADDR: "0.0.0.0"
            ADDITIONAL_SERVICES: "app"
        ports:
            - "20001:50050"
            - "50051:50051"

    miner2:
        build:
            context: ./p2p-blockchain
            dockerfile: Dockerfile
        image: vsp-blockchain/miner:local
        environment:
            APP_PORT: "50050"
            P2P_PORT: "50051"
            APP_LISTEN_ADDR: "0.0.0.0"
            P2P_LISTEN_ADDR: "0.0.0.0"
            ADDITIONAL_SERVICES: "miner, blockchain_full, app"
        ports:
            - "20002:50050"

    miner3:
        build:
            context: ./p2p-blockchain
            dockerfile: Dockerfile
        image: vsp-blockchain/miner:local
        environment:
            APP_PORT: "50050"
            P2P_PORT: "50051"
            APP_LISTEN_ADDR: "0.0.0.0"
            P2P_LISTEN_ADDR: "0.0.0.0"
            ADDITIONAL_SERVICES: "miner, blockchain_full, app"
        ports:
            - "20003:50050"

    miner4:
        build:
            context: ./p2p-blockchain
            dockerfile: Dockerfile
        image: vsp-blockchain/miner:local
        environment:
            APP_PORT: "50050"
            P2P_PORT: "50051"
            APP_LISTEN_ADDR: "0.0.0.0"
            P2P_LISTEN_ADDR: "0.0.0.0"
            ADDITIONAL_SERVICES: "miner, blockchain_full, app"
        ports:
            - "20004:50050"

    spv:
        build:
            context: ./p2p-blockchain
            dockerfile: Dockerfile
        image: vsp-blockchain/miner:local
        environment:
            APP_PORT: "50050"
            P2P_PORT: "50051"
            APP_LISTEN_ADDR: "0.0.0.0"
            P2P_LISTEN_ADDR: "0.0.0.0"
            ADDITIONAL_SERVICES: "wallet, blockchain_simple, app"
        ports:
            - "20005:50050"

    registry-crawler:
        build:
            context: ./registry-crawler
            dockerfile: Dockerfile
        image: vsp-blockchain/registry-crawler:local
        depends_on:
            - minimal_node
            - miner2
            - miner3
            - miner4
            - spv
        environment:
            APP_GRPC_ADDR_PORT: "minimal_node:50050"
            P2P_PORT: "50051"
            K8S_DISABLED: "true"
            SEED_UPDATE_INTERVAL: "30s"
            SEED_BOOTSTRAP_ENDPOINTS: "miner2:50051,miner3:50051"
            SEED_HOSTS_FILE: "/seed/seed.hosts"
        volumes:
            - seed-dns-hosts:/seed

    seed-dns:
        image: coredns/coredns:1.11.3
        command: ["-conf", "/etc/coredns/Corefile"]
        depends_on:
            - registry-crawler
        ports:
            - "1053:53/udp"
            - "1053:53/tcp"
        volumes:
            - ./local/seed-dns/Corefile:/etc/coredns/Corefile:ro
            - seed-dns-hosts:/seed:ro

    rest-api:
        build:
            context: ./rest-schnittstelle
            dockerfile: Dockerfile
        image: vsp-blockchain/rest-api:local
        depends_on:
            - spv
        environment:
            GRPC_ADDR_PORT: "spv:50051"
        ports:
            - "8080:8080"

volumes:
    seed-dns-hosts: {}
