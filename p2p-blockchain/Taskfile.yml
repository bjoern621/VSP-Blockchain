version: "3"

vars:
    DOCKER_TAG: latest

tasks:
    tidy:
        internal: true
        desc: Run go mod tidy
        cmds:
            - go mod tidy

    proto:
        desc: Generate gRPC code from shared and local .proto files
        dir: ..
        cmds:
            - buf generate

    prepare:
        desc: Prepare the module for build
        cmds:
            - task: proto
            - task: tidy

    test:
        desc: Run tests with race detector
        cmds:
            - go test ./...

    build:
        desc: Build the docker image for p2p-node
        cmds:
            - task: prepare
            - docker build -t vsp-blockchain/node:{{.DOCKER_TAG}} .
