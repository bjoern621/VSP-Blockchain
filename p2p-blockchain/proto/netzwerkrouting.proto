// Great reference: https://en.bitcoin.it/wiki/Protocol_documentation

syntax="proto3";

package netzwerkrouting;

import "google/protobuf/empty.proto";

option go_package = "./internal/pb";

service ConnectionEstablishment {
    // Version starts the connection establishment.
    rpc Version(VersionInfo) returns (google.protobuf.Empty);

    // Verack acknowledges a Version message.
    //
    // Pre-conditions:
    //  - Received a valid Version message.
    //
    // Post-conditions:
    //  - Connection is considered handshaked (but not fully established until Ack).
    rpc Verack(VersionInfo) returns (google.protobuf.Empty);

    // Ack acknowledges a Verack message and completes the connection establishment.
    //
    // Pre-conditions:
    //  - Received a valid Verack message.
    //
    // Post-conditions:
    //  - Connection is fully established and ready for data exchange.
    rpc Ack(google.protobuf.Empty) returns (google.protobuf.Empty);
}

service PeerDiscovery {
    // GetAddr is sent by another peer in order to discover new peers.
    // The server should respond with an Addr message.
    //
    // Pre-conditions:
    //  - Connection established.
    //
    // Post-conditions:
    //  - Server responds with an Addr message containing known peer addresses.
    rpc GetAddr(google.protobuf.Empty) returns (google.protobuf.Empty);

    // Addr shares addresses of known peers.
    // The AddrList NEVER includes the receiving peer's address.
    //
    // Pre-conditions:
    //  - Connection established.
    //  - Response to GetAddr or unsolicited announcement.
    //
    // Post-conditions:
    //  - New addresses added to known addresses list.
    rpc Addr(AddrList) returns (google.protobuf.Empty);

    // HeartbeatBing is a keep-alive message sent to check if a peer is still active.
    // The receiving peer should respond with a HeartbeatBong.
    //
    // Pre-conditions:
    //  - Connection established.
    //
    // Post-conditions:
    //  - Receiver updates LastSeen timestamp and responds with HeartbeatBong.
    rpc HeartbeatBing(google.protobuf.Empty) returns (google.protobuf.Empty);

    // HeartbeatBong is the response to a HeartbeatBing message.
    //
    // Pre-conditions:
    //  - Received a HeartbeatBing message.
    //
    // Post-conditions:
    //  - Receiver updates LastSeen timestamp for the peer that sent the bing.
    rpc HeartbeatBong(google.protobuf.Empty) returns (google.protobuf.Empty);
}

service ErrorHandling {
    // Reject signals a fault in a received message to another peer.
    //
    // Pre-conditions:
    //  - Connection established.
    //  - A malformed or invalid message was received.
    //
    // Post-conditions:
    //  - Error handled (e.g. logging).
    rpc Reject(Error) returns (google.protobuf.Empty);
}

enum ErrorType {
    // REJECT_MALFORMED indicates a message that cannot be parsed or has an incorrect format.
    // This is used for syntax errors, missing required fields, or any case where the message
    // structure itself is invalid regardless of content.
    //
    // Examples:
    //  - Missing required fields in protobuf message
    //  - Invalid hash length or format
    //  - Corrupted data that cannot be deserialized
    REJECT_MALFORMED = 0;

    // REJECT_INVALID indicates a well-formed message that fails validation logic.
    // The message structure is correct, but the content does not satisfy business rules
    // or consensus requirements.
    //
    // Examples:
    //  - Block with hash larger than target (invalid proof-of-work)
    //  - Transaction with invalid signature
    //  - Block header that doesn't match merkleroot
    //  - Transaction spending non-existent UTXO
    REJECT_INVALID = 1;

    // REJECT_HOLDDOWN indicates a peer that is considered unavailable after a disconnect.
    //
    // Use cases:
    //  - Peer is considered disconnected and needs to wait until a new connection can be established
    REJECT_HOLDDOWN = 2;

    // REJECT_NOT_CONNECTED indicates that a message was received from a peer that
    // is not in an established connection state. This occurs when a peer attempts to
    // send data before completing the connection handshake for example.
    //
    // Examples:
    //  - Peer sent data before Verack was exchanged
    //  - Message received from peer that failed authentication
    //  - Peer sent data without completing version handshake
    REJECT_NOT_CONNECTED = 3;
}

message Error {
    ErrorType error_type = 1;
    string rejected_message_type = 2; // I.e. "getdata", "headers", "addr", ...
    bytes data = 3;
}

enum ServiceType {
    SERVICE_WALLET = 0;
    SERVICE_MINER = 1;
    SERVICE_BLOCKCHAIN_FULL = 2;
    SERVICE_BLOCKCHAIN_SIMPLE = 3;
    SERVICE_NETZWERKROUTING = 4;
}

message VersionInfo {
    string version = 1; // Arbitrary implementation identifier, e.g. "core-0.9.0"
    repeated ServiceType supported_services = 2;
    Endpoint listening_endpoint = 3;
}

message Endpoint {
    // GRPC specific addr:port
    // Domain uses a generic string peer_id for identification
    bytes ip_address = 1;
    uint32 listening_port = 2;
}

message PeerAddress {
    Endpoint listening_endpoint = 1;
    int64 last_active_timestamp = 2;
}

message AddrList {
    repeated PeerAddress peers = 1;
}