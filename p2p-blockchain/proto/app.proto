// External API for local system communication.
// This service provides an interface for external software on the local device
// to interact with the p2p-blockchain node.
// 
// Note: This is different from the netzwerkrouting RPC which handles
// peer-to-peer communication between nodes in the network.

syntax="proto3";

package app;

import "google/protobuf/struct.proto";
import "google/protobuf/empty.proto";

option go_package = "./internal/pb";

// AppService provides an interface for external local systems to interact with the node.
service AppService {
    // ConnectTo instructs the node to establish a connection to a peer at the given address.
    //
    // Post-conditions:
    //  - Node attempts to connect to the specified peer.
    //  - Returns success/failure status.
    rpc ConnectTo(ConnectToRequest) returns (ConnectToResponse);

    // Disconnect instructs the node to disconnect from a peer.
    //
    // Post-conditions:
    //  - Node disconnects from the specified peer.
    //  - Returns success/failure status.
    rpc Disconnect(DisconnectRequest) returns (DisconnectResponse);

    // GetInternalPeerInfo returns the current internal state per peer for debugging purposes.
    rpc GetInternalPeerInfo(GetInternalPeerInfoRequest) returns (GetInternalPeerInfoResponse);

    // QueryRegistry queries the DNS seed registry for available peer addresses.
    //
    // Post-conditions:
    //  - Returns a list of peer addresses from the DNS seed.
    rpc QueryRegistry(QueryRegistryRequest) returns (QueryRegistryResponse);

    // GenerateKeyset Generates a completely new Keyset with a new random private Key
    rpc GenerateKeyset(google.protobuf.Empty) returns (GenerateKeysetResponse);

    // GetKeysetFromWIF Gets the complete keyset from the WIF encoded private key
    rpc GetKeysetFromWIF (GetKeysetFromWIFRequest) returns (GetKeysetFromWIFResponse);

    // SendGetAddr sends a getaddr message to the specified peer to request peer addresses.
    //
    // Post-conditions:
    //  - Sends getaddr message to the specified peer.
    //  - Returns success/failure status.
    rpc SendGetAddr(SendGetAddrRequest) returns (SendGetAddrResponse);

    // CreateTransaction creates and broadcasts a new transaction.
    //
    // Pre-conditions:
    //  - Sender must have sufficient funds (UTXOs) to cover amount.
    //  - Private key must be valid
    //
    // Post-conditions:
    //  - Transaction is created, signed, validated and broadcast to the network.
    //  - Returns success/failure status with error details.
    rpc CreateTransaction(CreateTransactionRequest) returns (CreateTransactionResponse);

    // GetAssets returns the assets (UTXOs) for a given V$Address.
    //
    // Pre-conditions:
    //  - V$Address must be a valid Base58Check encoded public key hash.
    //
    // Post-conditions:
    //  - Returns list of assets (UTXO values) for the address.
    rpc GetAssets(GetAssetsRequest) returns (GetAssetsResponse);

    // GetBlockchainVisualization returns a DOT file representation of the blockchain structure.
    // This can be used with Graphviz to visualize the blockchain including the main chain,
    // side chains, and orphan blocks.
    //
    // Post-conditions:
    //  - Returns a DOT format string that can be rendered with Graphviz.
    rpc GetBlockchainVisualization(GetBlockchainVisualizationRequest) returns (GetBlockchainVisualizationResponse);

    // StartMining starts the mining process to create new blocks.
    //
    // Post-conditions:
    //  - Miner begins attempting to create new blocks.
    //  - Returns success/failure status.
    rpc StartMining(google.protobuf.Empty) returns (StartMiningResponse);

    // StopMining stops the ongoing mining process.
    //
    // Post-conditions:
    //  - Miner stops attempting to create new blocks.
    //  - Returns success/failure status.
    rpc StopMining(google.protobuf.Empty) returns (StopMiningResponse);
}

message ConnectToRequest {
    // IP address of the peer to connect to (IPv4 or IPv6).
    bytes ip_address = 1;
    // Domain layer: uint16
    uint32 port = 2;
}

message ConnectToResponse {
    bool success = 1;
    string error_message = 2;
}

message DisconnectRequest {
    // IP address of the peer to disconnect from (IPv4 or IPv6).
    bytes ip_address = 1;
    // Domain layer: uint16
    uint32 port = 2;
}

message DisconnectResponse {
    bool success = 1;
    string error_message = 2;
}

message GetInternalPeerInfoRequest {}

message GetInternalPeerInfoResponse {
    repeated InternalPeerInfoEntry entries = 1;
}

message InternalPeerInfoEntry {
    string peer_id = 1;

    // Infrastructure data as a JSON object.
    // Uses google.protobuf.Struct which automatically serializes to native JSON.
    google.protobuf.Struct infrastructure_data = 2;
    
    // Domain-Peer information
    string version = 3; // Protocol version string
    repeated string supported_services = 4;
    string connection_state = 5;
    int64 last_seen = 6; // Unix timestamp when the peer was last seen active
}

message QueryRegistryRequest {
    // The DNS hostname to query for peer addresses.
    string hostname = 1;
}

message QueryRegistryResponse {
    // List of peer addresses returned from the DNS query.
    repeated RegistryEntry entries = 1;
}

message RegistryEntry {
    // IP address of the peer.
    string ip_address = 1;
    // Peer ID assigned to this discovered peer.
    string peer_id = 2;
}

message Keyset{
  bytes private_key = 1;
  string private_key_wif = 2;
  bytes public_key = 3;
  string VSAddress = 4;
}

message GenerateKeysetResponse{
  Keyset keyset = 1;
}

message GetKeysetFromWIFRequest{
  string private_key_wif = 1;
}

message GetKeysetFromWIFResponse{
  Keyset keyset = 1;
  bool falseInput = 2;
}

message SendGetAddrRequest {
    // Peer ID of the peer to send getaddr message to.
    string peer_id = 1;
}

message SendGetAddrResponse {
    bool success = 1;
    string error_message = 2;
}

// CreateTransactionRequest contains the data needed to create a new transaction.
message CreateTransactionRequest {
    // The recipient's V$Address (Base58Check encoded public key hash)
    string recipient_vs_address = 1;
    // The amount of V$Goin to transfer (must be >= 1).
    uint64 amount = 2;
    // The sender's private key in WIF format (Base58Check encoded)
    string sender_private_key_wif = 3;
}

// GetAssetsRequest contains the V$Address to query the assets for.
message GetAssetsRequest {
    // The V$Address (Base58Check encoded) to query
    string vs_address = 1;
}

// GetAssetsResponse contains the assets result.
message GetAssetsResponse {
    bool success = 1;
    string error_message = 2;
    // List of assets (UTXO values) belonging to the address
    repeated Asset assets = 3;
}

// Asset represents a single unspent output value.
message Asset {
    uint64 value = 1;
}

// CreateTransactionResponse contains the result of the transaction creation.
message CreateTransactionResponse {
    bool success = 1;
    TransactionErrorCode error_code = 2;
    // Human-readable error message with details.
    string error_message = 3;
    // The transaction ID if successful
    string transaction_id = 4;
}

// TransactionErrorCode categorizes transaction creation failures.
enum TransactionErrorCode {
    NONE = 0;
    INVALID_PRIVATE_KEY = 1;
    INSUFFICIENT_FUNDS = 2;
    VALIDATION_FAILED = 3;
    BROADCAST_FAILED = 4;
}

// GetBlockchainVisualizationRequest contains options for generating the DOT visualization.
message GetBlockchainVisualizationRequest {
    // Optional: If true, includes more details in node labels (height, accumulated work)
    bool include_details = 1;
}

// GetBlockchainVisualizationResponse contains a URL to visualize the blockchain.
message GetBlockchainVisualizationResponse {
    // A URL to GraphvizOnline that displays the blockchain visualization.
    // Can be opened directly in a browser.
    string visualization_url = 1;
}

// StartMiningResponse contains the result of starting the mining process.
message StartMiningResponse {
    bool success = 1;
    string error_message = 2;
}

// StopMiningResponse contains the result of stopping the mining process.
message StopMiningResponse {
    bool success = 1;
    string error_message = 2;
}
